from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command
from aiogram.exceptions import TelegramBadRequest
from sqlalchemy.ext.asyncio import AsyncSession
from app.keyboards.inline_kb import get_start_kb
from app.handlers.admin.admin_panel import process_admin_panel

router = Router()

@router.message(Command('start'))
async def cmd_start(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    await message.answer(
        f"üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {message.from_user.first_name}!\n\n"
        "–Ø –±–æ—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–π –º–µ–∂–¥—É –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–º–∏ –ø–∞—Ä–∞–º–∏.\n\n"
        "üîç –Ø –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ü–µ–Ω—ã –Ω–∞ Binance –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –∫–æ–≥–¥–∞ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—é "
        "–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –º–µ–∂–¥—É –≤–∞–ª—é—Ç–Ω—ã–º–∏ –ø–∞—Ä–∞–º–∏.\n\n"
        "–î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /admin",
        reply_markup=get_start_kb()
    )
    print(message.from_user)

@router.message(Command('help'))
async def cmd_help(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    await message.answer(
        "üìö <b>–°–ø—Ä–∞–≤–∫–∞ –ø–æ –±–æ—Ç—É</b>\n\n"
        "<b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
        "/start - –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞\n"
        "/help - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É\n"
        "/admin - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n\n"
        "<b>–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –±–æ—Ç?</b>\n"
        "–ë–æ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ü–µ–Ω—ã –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã—Ö –ø–∞—Ä –Ω–∞ Binance –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏ –º–µ–∂–¥—É –Ω–∏–º–∏. "
        "–ö–æ–≥–¥–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –∑–∞–¥–∞–Ω–Ω—ã–π –ø–æ—Ä–æ–≥, –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –≥—Ä—É–ø–ø—É.\n\n"
        "<b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</b>\n"
        "1. –ê–¥–º–∏–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç –≤–∞–ª—é—Ç–Ω—ã–µ –ø–∞—Ä—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è\n"
        "2. –ë–æ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ü–µ–Ω—ã –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏\n"
        "3. –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n\n"
        "<b>–î–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É</b>\n"
        "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.",
        parse_mode='HTML'
    )

@router.callback_query(F.data == 'about')
async def cb_about(callback: CallbackQuery):
    try:
        await callback.message.edit_text(
            "ü§ñ <b>–û –±–æ—Ç–µ</b>\n\n"
            "–≠—Ç–æ—Ç –±–æ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –¥–ª—è —Ç—Ä–µ–π–¥–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç—è—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏ "
            "–º–µ–∂–¥—É —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–º–∏ –ø–∞—Ä–∞–º–∏.\n\n"
            "<b>–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>\n"
            "‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –≤–∞–ª—é—Ç–Ω—ã—Ö –ø–∞—Ä\n"
            "‚Ä¢ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–æ—Ä–æ–≥–∏ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–π\n"
            "‚Ä¢ –û–ø–æ–≤–µ—â–µ–Ω–∏—è –≤ Telegram –≥—Ä—É–ø–ø—É –∏–ª–∏ –∫–∞–Ω–∞–ª\n"
            "‚Ä¢ –ì–∏–±–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤\n"
            "‚Ä¢ –£–¥–æ–±–Ω–∞—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å\n\n"
            "<b>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:</b>\n"
            "‚Ä¢ Python 3.10+\n"
            "‚Ä¢ aiogram 3.x\n"
            "‚Ä¢ SQLAlchemy 2.0\n"
            "‚Ä¢ PostgreSQL\n"
            "‚Ä¢ Binance API\n\n"
            "–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –±–æ—Ç–æ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /admin",
            reply_markup=get_start_kb(),
            parse_mode='HTML'
        )
    except TelegramBadRequest as e:
        if 'message is not modified' in str(e):
            pass
        else:
            raise
    await callback.answer()

@router.callback_query(F.data == 'admin_panel')
async def cb_admin_panel(callback: CallbackQuery, session: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å'"""
    await callback.message.answer('–ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞...')
    await process_admin_panel(callback.from_user, session)
    await callback.answer()